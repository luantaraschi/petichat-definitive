// PetiChat Prisma Schema
// Multi-tenant SaaS for legal petition creation with AI support

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector, pgcrypto]
}

// ============================================
// AUTH & MULTI-TENANT
// ============================================

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique
  name          String?
  passwordHash  String?   @map("password_hash")
  emailVerified DateTime? @map("email_verified")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  memberships Membership[]
  cases       Case[]
  documents   Document[]
  auditLogs   AuditLog[]
  accounts    Account[]
  sessions    Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String   @unique
  plan      PlanType @default(FREE)
  logoUrl   String?  @map("logo_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberships    Membership[]
  cases          Case[]
  documents      Document[]
  auditLogs      AuditLog[]
  jurisprudences Jurisprudence[]

  @@map("organizations")
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

model Membership {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String         @map("user_id") @db.Uuid
  organizationId String         @map("organization_id") @db.Uuid
  role           MembershipRole @default(MEMBER)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
}

// ============================================
// TEMPLATES
// ============================================

model Template {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  category    String // e.g., "Civel", "Penal", "Administrativo"
  area        String? // Legal area
  rito        String? // Legal procedure type
  isPopular   Boolean @default(false) @map("is_popular")
  isActive    Boolean @default(true) @map("is_active")
  structure   Json // Template structure definition
  prompts     Json? // AI prompts for this template
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  cases Case[]

  @@map("templates")
}

// ============================================
// CASES
// ============================================

model Case {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String     @map("organization_id") @db.Uuid
  userId         String     @map("user_id") @db.Uuid
  templateId     String?    @map("template_id") @db.Uuid

  title             String
  clientName        String?    @map("client_name")
  status            CaseStatus @default(DRAFT)

  // Wizard data
  facts             String?    @db.Text
  tribunal          String?
  foro              String?
  valorCausa        Decimal?   @map("valor_causa") @db.Decimal(15, 2)
  gratuidadeJustica Boolean    @default(false) @map("gratuidade_justica")
  tom               String? // e.g., "formal", "assertivo", "conciliador"

  // Triage responses
  triageResponses   Json?      @map("triage_responses")

  // Wizard step tracking
  currentStep       Int        @default(0) @map("current_step")
  completedSteps    Int[]      @default([]) @map("completed_steps")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id])
  template     Template?        @relation(fields: [templateId], references: [id])
  attachments  CaseAttachment[]
  theses       Thesis[]
  citations    Citation[]
  documents    Document[]

  @@index([organizationId])
  @@index([userId])
  @@map("cases")
}

enum CaseStatus {
  DRAFT
  TRIAGE
  THESES
  JURISPRUDENCE
  EDITING
  COMPLETED
  ARCHIVED
}

model CaseAttachment {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId        String   @map("case_id") @db.Uuid
  fileName      String   @map("file_name")
  fileType      String   @map("file_type")
  fileSize      Int      @map("file_size")
  storageKey    String   @map("storage_key")
  extractedText String?  @map("extracted_text") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_attachments")
}

// ============================================
// THESES & CLAIMS
// ============================================

model Thesis {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId      String       @map("case_id") @db.Uuid

  title       String
  content     String       @db.Text
  type        ThesisType   @default(THESIS)
  status      ThesisStatus @default(PENDING)
  order       Int          @default(0)
  aiGenerated Boolean      @default(false) @map("ai_generated")

  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  case      Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  citations Citation[]

  @@index([caseId])
  @@map("theses")
}

enum ThesisType {
  THESIS      // Legal argument/thesis
  CLAIM       // Pedido
  PRELIMINARY // Preliminar
}

enum ThesisStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVISION
}

// ============================================
// JURISPRUDENCE
// ============================================

model Jurisprudence {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?  @map("organization_id") @db.Uuid // null = global

  // Required metadata (rule: never insert without these)
  tribunal       String // e.g., "STJ", "TJSP"
  orgaoJulgador  String?  @map("orgao_julgador") // e.g., "1a Turma"
  numero         String // Case number
  dataJulgamento DateTime @map("data_julgamento")
  relator        String?

  // Content
  ementa         String   @db.Text
  inteiro        String?  @db.Text @map("inteiro") // Full text if available

  // Source tracking (rule: mandatory)
  fonte          String // e.g., "STJ Portal Dados Abertos"
  linkOriginal   String?  @map("link_original")
  dataImportacao DateTime @default(now()) @map("data_importacao")

  // Classification
  area           String? // Legal area
  assuntos       String[] // Subjects/topics

  // Status
  isActive       Boolean  @default(true) @map("is_active")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization?        @relation(fields: [organizationId], references: [id])
  chunks       JurisprudenceChunk[]

  @@index([tribunal, numero])
  @@index([organizationId])
  @@index([area])
  @@map("jurisprudences")
}

model JurisprudenceChunk {
  id              String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jurisprudenceId String                       @map("jurisprudence_id") @db.Uuid

  content         String                       @db.Text
  chunkType       String                       @map("chunk_type") // "ementa", "trecho", "fundamento"
  embedding       Unsupported("vector(1536)")?

  // For FTS
  searchVector    Unsupported("tsvector")?     @map("search_vector")

  createdAt       DateTime                     @default(now()) @map("created_at")

  jurisprudence Jurisprudence @relation(fields: [jurisprudenceId], references: [id], onDelete: Cascade)
  citations     Citation[]

  @@index([jurisprudenceId])
  @@map("jurisprudence_chunks")
}

// ============================================
// CITATIONS (linking jurisprudence to documents)
// ============================================

model Citation {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseId     String   @map("case_id") @db.Uuid
  chunkId    String   @map("chunk_id") @db.Uuid
  thesisId   String?  @map("thesis_id") @db.Uuid
  documentId String?  @map("document_id") @db.Uuid

  // Citation context
  excerpt    String   @db.Text // The specific excerpt being cited
  position   Int? // Position in document if inserted
  note       String?  @db.Text // User note about this citation

  createdAt  DateTime @default(now()) @map("created_at")

  case     Case               @relation(fields: [caseId], references: [id], onDelete: Cascade)
  chunk    JurisprudenceChunk @relation(fields: [chunkId], references: [id])
  thesis   Thesis?            @relation(fields: [thesisId], references: [id])
  document Document?          @relation(fields: [documentId], references: [id])

  @@index([caseId])
  @@index([documentId])
  @@map("citations")
}

// ============================================
// DOCUMENTS
// ============================================

model Document {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String         @map("organization_id") @db.Uuid
  caseId         String         @map("case_id") @db.Uuid
  userId         String         @map("user_id") @db.Uuid

  title          String
  content        Json // TipTap JSON content
  version        Int            @default(1)
  status         DocumentStatus @default(DRAFT)

  // Export tracking
  lastExportedAt DateTime?      @map("last_exported_at")
  exportFormat   String?        @map("export_format")

  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  case         Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  citations    Citation[]

  @@index([organizationId])
  @@index([caseId])
  @@map("documents")
}

enum DocumentStatus {
  DRAFT
  REVIEW
  FINAL
  EXPORTED
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid

  action         String // e.g., "document.generate", "ai.inline_action", "juris.search"
  entityType     String?  @map("entity_type") // e.g., "Document", "Case"
  entityId       String?  @map("entity_id") @db.Uuid

  // AI tracking
  aiModel        String?  @map("ai_model")
  tokensInput    Int?     @map("tokens_input")
  tokensOutput   Int?     @map("tokens_output")
  estimatedCost  Decimal? @map("estimated_cost") @db.Decimal(10, 6)

  // Context
  metadata       Json?
  requestId      String?  @map("request_id")
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")

  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
